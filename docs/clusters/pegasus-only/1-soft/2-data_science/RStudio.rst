.. _p-rstudio:

RStudio on Pegasus
==================

Rstudio is available graphically as a singularity container. The current version is R/4.2.1 using a tidyverse base. 


Setup your $RSTUDIO_WORK_DIR
-------------------

::

    [pdavila@pegasus ~]$ echo "export RSTUDIO_WORK_DIR=/$HOME/rstudio/" >> ~/.bash_profile
    [pdavila@pegasus ~]$ source ~/.bash_profile
    [pdavila@pegasus ~]$ mkdir -p $RSTUDIO_WORK_DIR
    [pdavila@pegasus ~]$ cp /projectnb/pegasus/sw/rstudio/pegasus_rstudio_lsf.* $RSTUDIO_WORK_DIR/
    
    [pdavila@pegasus rstudio]$ ls -lh $RSTUDIO_WORK_DIR/
    -rw-r--r-- 1 pdavila hpc           5.0K Aug 27 11:23 pegasus_rstudio_lsf.job
    -rwxr-xr-x 1 pdavila hpc            516 Aug 27 10:46 pegasus_rstudio_lsf.sh

       
Edit your rstudio_lsf.job Script 
----------------------------
You should set your project, queue, and email.  You may also want to update the requested LSF 1. runtime, cpu cores, and memory, defaults below.  

::

    [pdavila@login4 ~]$ module load python
    [pdavila@login4 ~]$ module load singularity 
    [pdavila@login4 ~]$ cd $RSTUDIO_WORK_DIR   # Edit the Job script
    [pdavila@login4 rstudio]$ head -20 $RSTUDIO_WORK_DIR/pegasus_rstudio_lsf.job
    #!/bin/sh
    #BSUB -J rstudio_server         # Job Name
    #BSUB -o %J.out                 # Save standard output to JOBID.out
    #BSUB -e %J.err                 # Save standard error to JOBID.err
    #BSUB -P projectID              # Project ID 
    #BSUB -q normal                 # Select LSF Queue 
    #BSUB -W 8:00                   # 8 hours, 0 minutes job walltime (runtime)
    #BSUB -n 1                      # Set n = number of cores (1 in this template)
    #BSUB -R "span[hosts=1]"        # Select all cores from the same host
    #BSUB -R "rusage[mem=7800]"     # Requests 7,800 MB of RAM per core
    #BSUB -u email@miami.edu        # Email address to send notification to
    #BSUB -B                        # Email user (-u) when job is dispatched and begins execution
    #BSUB -N                        # Email user (-u) job statistics report when job finishes.
     
    ###############################################################################
    # DEFAUTS
    ###############################################################################
     
    module load singularity
     
    LOGIN_NODE="pegasus2.ccs.miami.edu"
    R="4.2.1"
    BASE="tidyverse"
     
    IMAGE="rocker/${BASE}:${R}"
    IMAGE_DIR="/projectnb/pegasus/sw/rstudio/sif"
    SIF="${IMAGE_DIR}/${BASE}_${R}.sif"
    SINGULARITY_BIND="/scratch,/projectnb"

    


Run RSTUDIO on Pegasus Nodes
-------------------------------------
The wrapper script will return your JOBID, RStudio Server URL, and credentials.  It will also return the LSF command you can use to close your job, should you finish your work in less time than the requested runtime (-W 8:00). Please follow the instructions as detailed in the job message. Example below:

::

    [pdavila@pegasus ~]$ cd $RSTUDIO_WORK_DIR
    [pdavila@pegasus rstudio]$ ./pegasus_rstudio_lsf.sh 
    Job is submitted to <projectID> project.
    JOBID: 28929532
     
    << output from stdout >>
    The RStudio Singularity container (/projectnb/pegasus/sw/rstudio/sif/tidyverse_4.2.1.sif) is available.
     
     1. Create an SSH tunnel from your workstation in a new terminal with the
        following command:
     
       ssh -N -L 8787:n127:60218 pdavila@pegasus.ccs.miami.edu
     
       and point your web browser to http://localhost:8787
     
    2. log in to RStudio Server using the following credentials:
     
       user: pdavila
       password: aTAfBBKffxjdDsu+y4fs
     
    When done using RStudio Server, terminate the job by:
     
    1. Exit the RStudio Session ("power" button in the top right corner of the RStudio window)
    2. Issue the following command on the login node:
     
          bkill 28929505
     
    << output from stderr >>


The RStudio graphical interface will then appear, from which you can utilize and install any needed packages. Remember to create an ssh tunnel by opening a new terminal on your local machine and running the ssh command as specified above.

**DO NOT SHARE YOUR RSTUDIO JOB CREDENTIALS!!!**
 
The password generated by pegasus_rstudio_lsf.sh is a randomly generated per JOB.
THE JOB WILL HAVE ACCESS TO ALL SINGULARITY_BIND DIRECTORIES YOU HAVE ACCESS TO ON PEGASUS.





If you run into any issues, please submit a ticket using the `IDSC – HPC Cluster: Report a Problem form <https://uhealth.service-now.com/esc?id=sc_cat_item&sys_id=ec74f27d47162290ddc5bfca116d43c4>`_.
